// @ts-nocheck
let input=document.getElementById("input"),preview=document.getElementById("preview"),expression="",lastResult=null;function initTheme(){const e=document.getElementById("theme-switch");"dark"===localStorage.getItem("calculator-theme")&&(document.body.setAttribute("data-theme","dark"),e.checked=!0),e.addEventListener("change",(function(){this.checked?(document.body.setAttribute("data-theme","dark"),localStorage.setItem("calculator-theme","dark")):(document.body.removeAttribute("data-theme"),localStorage.setItem("calculator-theme","light"))}))}function initButtons(){document.querySelectorAll(".button").forEach((e=>{e.addEventListener("click",(function(){handleButtonClick(this.getAttribute("data-value"))}))})),document.addEventListener("keydown",handleKeyPress)}function handleKeyPress(e){const t=e.key;/[0-9+\-*/.()%]/.test(t)?handleButtonClick(t):"Enter"===t?handleButtonClick("="):"Backspace"===t?handleButtonClick("backspace"):"Escape"===t?handleButtonClick("clear"):"^"===t&&handleButtonClick("pow")}function handleButtonClick(e){switch(e){case"clear":expression="",updateDisplay();break;case"backspace":expression=expression.slice(0,-1),updateDisplay();break;case"=":if(expression){try{lastResult=calculateExpression(expression),expression=lastResult.toString(),preview.textContent=""}catch(e){preview.textContent="错误"}updateDisplay()}break;case"sin":case"cos":case"tan":case"log":case"sqrt":expression+=e+"(",updateDisplay();break;case"pow":expression+="^",updateDisplay();break;case"pi":expression+="π",updateDisplay();break;case"e":expression+="e",updateDisplay();break;case"percent":if(expression)try{const e=calculateExpression(expression);expression=(e/100).toString(),updateDisplay()}catch(e){preview.textContent="错误"}break;default:expression+=e,updateDisplay()}}function updateDisplay(){let e=expression.replace(/\*/g,"×").replace(/\//g,"÷").replace(/\^/g,"^").replace(/π/g,"π").replace(/e/g,"e");if(input.textContent=e||"0",expression&&expression!==lastResult?.toString())try{const e=calculateExpression(expression);preview.textContent="= "+formatNumber(e),preview.style.opacity="1"}catch(e){preview.textContent="",preview.style.opacity="0"}else preview.textContent="",preview.style.opacity="0"}function calculateExpression(e){e=e.replace(/π/g,"Math.PI").replace(/e/g,"Math.E").replace(/\^/g,"**").replace(/sin\(/g,"Math.sin(").replace(/cos\(/g,"Math.cos(").replace(/tan\(/g,"Math.tan(").replace(/log\(/g,"Math.log10(").replace(/sqrt\(/g,"Math.sqrt(");try{return roundToSignificantDigits(Function("return "+e)(),12)}catch(e){throw new Error("计算错误")}}function roundToSignificantDigits(e,t){if(0===e)return 0;if(!isFinite(e)||isNaN(e))return e;const n=Math.abs(e);if(n<1e-10)return Number(e.toExponential(t-1));if(n>=1e10)return Number(e.toExponential(t-1));{const a=Math.max(0,t-Math.floor(Math.log10(n))-1);return Number(e.toFixed(a))}}function formatNumber(e){if(!isFinite(e))return e.toString();if(isNaN(e))return"NaN";if(Math.abs(e)<1e-10||Math.abs(e)>=1e10)return e.toExponential(6);if(Number.isInteger(e))return e.toString();const t=e.toString();return t.includes(".")?t.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,""):t}function initApp(){initTheme(),initButtons(),updateDisplay(),document.querySelectorAll(".button").forEach(((e,t)=>{e.style.animationDelay=.02*t+"s"}))}document.addEventListener("DOMContentLoaded",initApp);